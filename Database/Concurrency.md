Concurrency æ„å³ã€ŒåŒæ™‚é€²è¡Œã€ï¼Œåœ¨è³‡æ–™åº«ä¸­æŒ‡çš„å°±æ˜¯åŒæ™‚åœ¨é€²è¡Œçš„è‹¥å¹²å€‹ transactionsã€‚å…¶å¯¦ä¸åªåœ¨è³‡æ–™åº«é ˜åŸŸï¼Œåœ¨ operating system ä»¥åŠæ‰€æœ‰æ”¯æ´ multi-threading æˆ– multi-processing çš„ç¨‹å¼èªè¨€ä¸­ï¼Œconcurrency éƒ½æ˜¯é‡è¦çš„è­°é¡Œï¼Œå› ç‚ºæœ‰äº›æ™‚å€™ï¼Œçœ‹ä¼¼æ²’æœ‰å•é¡Œçš„ç³»çµ±ï¼ç¨‹å¼é¢è‡¨ concurrency æ™‚ï¼Œå°±æœƒé–‹å§‹å‡ºç¾è®“äººç„¡æ³•é æ¸¬çš„éŒ¯èª¤ã€‚

# Concurrency Anomalies

Concurrency anomalies æŒ‡çš„å°±æ˜¯ç™¼ç”Ÿåœ¨è³‡æ–™åº«çš„ race conditionï¼ŒåŒ…å«ä»¥ä¸‹å…­ç¨®ï¼š

- [Dirty Read](<#Dirty Read>)
- [Non-Repeatable Read](<#Non-Repeatable Read>)
- [Phantom Read](<#Phantom Read>)
- [Dirty Write](<#Dirty Write>)
- [Lost Update](<#Lost Update>)
- [Write Skew](<#Write Skew>)

### Dirty Read

e.g.

ä¸€å€‹ [[æ·ºè«‡ Database#Database Transaction|transaction]] T1 è¦å°‡å•†å“å­˜è²¨ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ï¼Œä½†åŸ·è¡Œåˆ°ä¸€åŠæ™‚ï¼ˆåªå°‡å•†å“å­˜è²¨ -1ï¼‰å¦ä¸€å€‹ transaction T2 ä¾†è®€å–å•†å“å­˜è²¨èˆ‡è¨‚å–®ï¼Œç›®çš„æ˜¯æª¢æŸ¥ã€Œå•†å“å­˜è²¨ + è¨‚å–®ã€çš„ç¸½å’Œæ˜¯å¦æœ‰èª¤ã€‚

æ­¤æ™‚ T2 å¾—åˆ°çš„çµè«–å°±æ˜¯ã€Œæœ‰èª¤ã€ï¼Œå› ç‚ºå®ƒçœ‹åˆ°çš„ç‹€æ…‹æ˜¯è¨‚å–®é‚„æ²’è¢«å»ºç«‹å‰çš„ç‹€æ…‹ï¼Œå³ä½¿ä¸ä¹…å¾Œ T1 å°±å»ºç«‹äº†è¨‚å–®ã€‚

### Non-Repeatable Read

e.g.

æœ‰ä¸€å€‹ transaction T1 æœƒå…ˆå¾Œè®€å–å­˜è²¨æ•¸é‡å…©æ¬¡ï¼ŒåŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æ­£åœ¨åŸ·è¡Œï¼ŒT2 æœƒå°‡å•†å“å­˜è²¨æ•¸é‡ -1ã€æ–°å¢ä¸€ç­†è¨‚å–®ã€‚T1 ç¬¬ä¸€æ¬¡è®€å–æ™‚ï¼ŒT2 é‚„æ²’ commitï¼Œä½† T1 ç¬¬äºŒæ¬¡è®€å–æ™‚ï¼ŒT2 å·²ç¶“ commit äº†ï¼Œæ­¤æ™‚ T1 è®€å–åˆ°çš„å­˜è²¨æ•¸é‡å°±æœƒæ¯”ç¬¬ä¸€æ¬¡å°‘ä¸€å€‹ã€‚

### Phantom Read

e.g.

æœ‰ä¸€å€‹ transaction T1 ä¾†è®€å–æ‰€æœ‰è¨‚å–®ä¸¦è¨ˆç®—æ•¸é‡å…©æ¬¡ï¼ŒåŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æ­£åœ¨åŸ·è¡Œï¼ŒT2 æœƒå°‡å•†å“å­˜è²¨æ•¸é‡ -1ã€æ–°å¢ä¸€ç­†è¨‚å–®ã€‚T1 ç¬¬ä¸€æ¬¡è®€å–æ™‚ï¼ŒT2 é‚„æ²’ commitï¼Œä½† T1 ç¬¬äºŒæ¬¡è®€å–æ™‚ï¼ŒT2 å·²ç¶“æ–°å¢è¨‚å–®ä¸¦ commitï¼Œæ­¤æ™‚ T1 è¨ˆç®—å‡ºä¾†çš„è¨‚å–®æ•¸é‡å°±æœƒæ¯”ç¬¬ä¸€æ¬¡å¤šä¸€å€‹ã€‚

>[!Note]
>Non-Repeatable Read æ˜¯ç”±ã€ŒæŸäº›è³‡æ–™çš„æŸäº›æ¬„ä½å€¼è¢«æ›´æ”¹ã€æ‰€å°è‡´ï¼›Phantom Read å‰‡æ˜¯ç”±ã€Œæ–°å¢æˆ–åˆªé™¤æŸäº›è³‡æ–™ã€æ‰€å°è‡´ã€‚

### Dirty Write

Dirty write åŒ…å«ä»¥ä¸‹å…©ç¨®ç¾è±¡ï¼š

- Transactions é€²è¡Œ rollback æ™‚ï¼Œåªæœƒå°‡è³‡æ–™ç‹€æ…‹é€€å›ã€Œå° transaction è‡ªå·±è€Œè¨€ã€çš„åŸå§‹ç‹€æ…‹ï¼Œé€™æœƒå°è‡´éç¨‹ä¸­çš„å…¶å®ƒ transactions å°é€™äº›è³‡æ–™åšçš„æ›´å‹•éƒ½è¢«æŠ¹é™¤
- Transaction åœ¨ rollback å‰ï¼Œè‹¥æœ‰å…¶å®ƒ transactions è®€åˆ°é‚„æ²’ rollback çš„ã€Œé«’è³‡æ–™ã€ï¼Œå°±æœ‰å¯èƒ½å› æ­¤åšå‡ºæœ€å¾Œçœ‹èµ·ä¾†éŒ¯èª¤çš„æ±ºç­–

e.g. (1)

å…©å€‹ transactions T1, T2 éƒ½æ˜¯è¦ã€Œå…ˆè®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œæœ€å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€ã€‚å‡è¨­åŸå­˜è²¨æ•¸é‡ç‚º 100ï¼ŒT1 å·²ç¶“è®€å–ä¸”ç‡å…ˆå°‡å…¶æ›´æ–°ç‚º 99ï¼Œæº–å‚™æ–°å¢è¨‚å–®ï¼Œæ­¤æ™‚ T2 æ‰è®€å–å­˜è²¨æ•¸é‡ (99)ï¼Œä¸¦ä¸”å°‡å…¶æ›´æ–°ç‚º 98ï¼Œç„¶å¾Œæº–å‚™æ–°å¢è¨‚å–®ã€‚ç„¶è€Œæ­¤æ™‚ T1 å› ç‚ºæ–°å¢è¨‚å–®å¤±æ•—è€Œ rollback å›ã€Œå°å®ƒ (T1) è€Œè¨€çš„åŸå§‹ç‹€æ…‹ã€ï¼Œæ‰€ä»¥å­˜è²¨æ•¸é‡è¢«æ”¹å› 100ï¼Œç„¶å¾Œ T2 æˆåŠŸæ–°å¢è¨‚å–®ã€‚æœ€çµ‚çš„çµæœæ˜¯å­˜è²¨ä¸è®Š (100)ï¼Œè¨‚å–®å»å¤šäº†ä¸€ç­†ã€‚

![[dirty_write.png]]

e.g. (2)

æŸå•†å“çš„å­˜è²¨å‰© 1 ä»¶ï¼Œç¾åœ¨æœ‰å…©å€‹ transactions T1, T2ï¼Œéƒ½æ˜¯è¦ã€Œå…ˆè®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œæœ€å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€ã€‚å‡è¨­ T1 å…ˆè®€å–ä¸¦å°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œç„¶å¾Œ T2 æ‰è®€å–å­˜è²¨æ•¸é‡ï¼Œæ­¤æ™‚å› ç‚ºå­˜è²¨ç‚º 0ï¼ŒT2 åˆ¤æ–·ä¸èƒ½ä¸‹è¨‚å–®ï¼Œå› æ­¤å‘Šè¨´æ¶ˆè²»è€…å•†å“å”®ç½„ï¼Œæ¥è‘— T1 å› ç‚ºæ–°å¢è¨‚å–®æ™‚å‡ºéŒ¯æ‰€ä»¥ rollbackï¼ˆå°‡å•†å“åº«å­˜æ”¹å› 1ï¼‰ï¼Œæ–¼æ˜¯æ¶ˆè²»è€…å°±ä¾†æŠ±æ€¨ç‚ºä»€éº¼æ˜æ˜çœ‹åˆ°åº«å­˜å‰© 1 å»è¢«å‘ŠçŸ¥å•†å“å”®ç½„ã€‚

### Lost Update

è‹¥åŒæ™‚æœ‰è‹¥å¹²å€‹ transactions è¦æ›´æ”¹åŒä¸€å€‹ rowï¼Œå‰‡è©²ç­†è³‡æ–™æœ€çµ‚çš„ç‹€æ…‹æ˜¯ç”±æœ€æ™š commit è€…æ±ºå®šã€‚

e.g.

å…©å€‹ transactions T1, T2 åŒæ™‚è¦è®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€‚å‡è¨­åŸå­˜è²¨æ•¸é‡ç‚º 100ï¼ŒT1, T2 éƒ½è®€åˆ° 100ï¼Œ-1 å¾Œå°±éƒ½æœƒæ˜¯ 99ï¼Œæ‰€ä»¥å•†å“å­˜è²¨å°±æœƒè¢«æ›´æ–°ç‚º 99 å…©æ¬¡ï¼Œç„¶è€Œè¨‚å–®å»å¤šäº†å…©ç­†ï¼Œå°è‡´ã€Œå•†å“å­˜è²¨ + è¨‚å–®ã€çš„çµæœèˆ‡åŸæœ¬ä¸ä¸€è‡´ã€‚

![[lost_update.png]]

### Write Skew

Write Skew èˆ‡ Lost Update é¡ä¼¼ï¼Œä½† lost update é—œæ³¨çš„æ˜¯å…©å€‹ transactions æ›´æ”¹åŒä¸€ç­†è³‡æ–™çš„åŒä¸€å€‹æ¬„ä½ï¼Œé€²è€Œå¼•ç™¼çš„ã€Œè³‡æ–™è¦†å¯«ã€å•é¡Œï¼›write skew å‰‡é—œæ³¨åœ¨å› è®€åˆ°éæ™‚è³‡æ–™è€Œé€ æˆçš„ã€ŒéŒ¯èª¤æ±ºå®šã€ã€‚

e.g.

æŸå•†å“çš„å­˜è²¨å‰© 1 ä»¶ï¼Œç¾åœ¨æœ‰å…©å€‹ transactions T1, T2ï¼Œéƒ½æ˜¯è¦ã€Œå…ˆè®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œæœ€å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€ã€‚è‹¥ T1 èˆ‡ T2 éƒ½è®€åˆ°å‰© 1 ä»¶å­˜è²¨ï¼Œå› æ­¤éƒ½è¦ºå¾—å­˜è²¨é‚„å¤ å°±å»ºç«‹äº†è¨‚å–®ï¼Œé‚£éº¼è³£å®¶å°±æœƒé ­å¾ˆç—›ã€‚ï¼ˆå…¶å¯¦é€™éš±å«äº† lost updateï¼ŒT1 èˆ‡ T2 éƒ½å°‡å­˜è²¨æ•¸é‡æ”¹ç‚º 0ï¼‰

# Concurrency Control Protocols

### åˆ†é¡

- ç©æ¥µå‹

    ä¸å¤šåšæª¢æŸ¥ï¼Œä¸ç®¡æœ‰å¤šå°‘å¹³è¡Œçš„ transactions éƒ½ç›´æ¥åŸ·è¡Œï¼Œå¦‚æœæœ‰èª° commit æ™‚å‡ºéŒ¯äº†ï¼Œå°± rollback é‚£äº›å‡ºéŒ¯çš„ transactions ä¸¦ retryï¼Œç›´åˆ°æˆåŠŸç‚ºæ­¢ã€‚

- æ¶ˆæ¥µå‹

    åŸ·è¡Œ transaction ä¸­çš„æ¯å€‹æ­¥é©Ÿæ™‚éƒ½å…ˆæª¢æŸ¥é€™å€‹å‹•ä½œæœƒä¸æœƒç ´å£ [[Integrity Constraint]]ï¼Œå¦‚æœæœƒå°±æŠŠè©² transaction block ä½ï¼Œç­‰å±æ©Ÿè§£é™¤å¾Œå†æ”¾è¡Œã€‚

    ç”±æ–¼æ¶ˆæ¥µå‹çš„ protocols å®¹æ˜“å°è‡´ [[Deadlocks]]ï¼Œå› æ­¤å¤šæ•¸ DBMS éƒ½æœ‰èˆ‡é˜²æ©Ÿåˆ¶ï¼Œæ¯”å¦‚å®šæœŸå°‡è¢« block éä¹…çš„ transaction åš rollback & retryã€‚

### æ‰‹æ®µ

##### ğŸ”“ Locking

ç•¶ä¸€å€‹ transaction T å­˜å–è³‡æ–™æ™‚ï¼Œå°‡é€™äº›è¢«å­˜å–çš„è³‡æ–™åŠ ä¸Š [[Locks]]ï¼Œè¢«åŠ ä¸Š lock çš„è³‡æ–™å°‡ç„¡æ³•è¢«å…¶å®ƒ transaction å­˜å–æˆ–åšæŸäº›æ“ä½œï¼ˆè¦– lock çš„ç¨®é¡è€Œå®šï¼‰ï¼Œç›´åˆ° T commit å¾Œæ‰å°‡ lock è§£é™¤ã€‚

##### Serialization Graph Checking

å°‡ concurrent transactions è½‰æ›æˆèˆ‡å…¶ã€Œç­‰åƒ¹ã€ï¼ˆæœ€å¾Œæœƒç”¢ç”Ÿç›¸åŒè³‡æ–™åº«ç‹€æ…‹ï¼‰çš„ serialized schedualï¼Œè‹¥å°‡é€™å€‹ schedual è¦–è¦ºåŒ–ç‚ºæµç¨‹åœ–ï¼Œå‰‡åœ–è£¡æ‡‰ä¸èƒ½å‡ºç¾ä»»ä½•ã€Œå¾ªç’°ã€ï¼Œè‹¥å‡ºç¾å‰‡æ‡‰ä»¥ã€Œæœ€å°æˆæœ¬ã€å°‡é€ æˆå¾ªç’°çš„ transaction(s) æ‹”é™¤ã€‚

å»é™¤å¾ªç’°å¾Œï¼Œä¸¦ä¸ä¸€å®šè¦çœŸçš„æŒ‰ç…§ serialized schedual ä¸€å€‹æ¥è‘—ä¸€å€‹åŸ·è¡Œï¼Œä»å¯ä»¥é¸æ“‡åŒæ™‚åŸ·è¡Œæ²’æœ‰è¢«å»é™¤çš„ transactionsã€‚

##### Timestamp Ordering

å°‡ concurrent transactions è½‰æ›æˆèˆ‡å…¶ã€Œç­‰åƒ¹ã€ï¼ˆæœ€å¾Œæœƒç”¢ç”Ÿç›¸åŒè³‡æ–™åº«ç‹€æ…‹ï¼‰çš„ serialized schedualï¼Œä¸¦ç¢ºå¯¦ä¾åºåŸ·è¡Œã€‚å°‡æ¯å€‹ transaction æ¨™è¨˜ä¸€å€‹å”¯ä¸€çš„ timestampï¼Œç”¨ä¾†æ±ºå®šåŸ·è¡Œé †åºã€‚

##### Commitment Ordering

å°‡æ¯å€‹ transaction æ¨™è¨˜ä¸€å€‹å”¯ä¸€çš„ timestampï¼Œç”¨ä¾†æ±ºå®šã€Œcommit çš„é †åºã€ï¼Œä¸¦ä¸”ç¢ºä¿ä¸‹é¢å…©ä»¶äº‹ï¼š

- Commitment order è¼ƒæ—©çš„ transaction ä¸æœƒå—åˆ° commitment order æ¯”è‡ªå·±æ™šçš„ transactions å½±éŸ¿

- Commitment order è¼ƒæ™šçš„ transaction å¯ä»¥å­˜å–åˆ°æ¯”è‡ªå·±æ—© commit çš„ transactions å°è³‡æ–™åº«æ‰€åšçš„è®Šå‹•

>[!Note]
>ä¸Šè¿°é€™äº›æ‰‹æ®µä¸¦éåªèƒ½æ“‡ä¸€ï¼Œå¯ä»¥æ­é…ä½¿ç”¨ã€‚

### ä¸»æµåšæ³•

- [[MVCC vs. SS2PL#MVCC|MVCC (Multi-Version Concurrency Control)]]
- [[MVCC vs. SS2PL#SS2PL|SS2PL (Strong-Strict Two-Phase Locking)]]

# åƒè€ƒè³‡æ–™

- <https://en.wikipedia.org/wiki/Concurrent_computing>
- <https://en.wikipedia.org/wiki/Concurrency_control>
