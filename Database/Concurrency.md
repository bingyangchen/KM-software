å…¶å¯¦ä¸åªåœ¨ Database çš„é ˜åŸŸï¼Œåœ¨ Operating System èˆ‡ç¨‹å¼èªè¨€çš„é ˜åŸŸä¸­ï¼ŒConcurrency éƒ½æ˜¯é‡è¦çš„è­°é¡Œã€‚

# Concurrency Anomalies

å¯ä»¥ç°¡å–®åœ°å°‡ Concurrency Anomalies ç†è§£ç‚ºè³‡æ–™åº«ä¸–ç•Œè£¡çš„ Race Conditionã€‚Concurrency Anomalies åŒ…å«ä»¥ä¸‹å…­ç¨®ï¼š

- [Dirty Read](<#Dirty Read>)
- [Non-Repeatable Read](<#Non-Repeatable Read>)
- [Phantom Read](<#Phantom Read>)
- [Lost Update](<#Lost Update>)
- [Dirty Write](<#Dirty Write>)
- [Write Skew](<#Write Skew>)

### Dirty Read

èˆ‰ä¾‹ï¼š

ä¸€å€‹ transaction T1 è¦å°‡å•†å“å­˜è²¨ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ï¼Œä½†åŸ·è¡Œåˆ°ä¸€åŠæ™‚ï¼ˆåªå°‡å•†å“å­˜è²¨ -1ï¼‰å¦ä¸€å€‹ transaction T2 ä¾†è®€å–å•†å“å­˜è²¨èˆ‡è¨‚å–®ï¼Œç›®çš„æ˜¯æª¢æŸ¥ã€Œå•†å“å­˜è²¨ + è¨‚å–®ã€çš„ç¸½å’Œæ˜¯å¦æœ‰èª¤ï¼Œæ­¤æ™‚ T2 å¾—åˆ°çš„çµè«–å°±æ˜¯ã€Œæœ‰èª¤ã€ï¼Œå› ç‚ºå®ƒçœ‹åˆ°çš„ç‹€æ…‹æ˜¯è¨‚å–®é‚„æ²’è¢«å»ºç«‹å‰çš„ç‹€æ…‹ï¼Œå³ä½¿ä¸ä¹…å¾Œ T1 å°±å»ºç«‹äº†è¨‚å–®ã€‚

### Non-Repeatable Read

èˆ‰ä¾‹ï¼š

æœ‰ä¸€å€‹ transaction T1 ä¾†è®€å–å­˜è²¨æ•¸é‡å…©æ¬¡ï¼ŒåŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æ­£åœ¨åŸ·è¡Œï¼ŒT2 åŒ…å«è®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ã€æ–°å¢ä¸€ç­†è¨‚å–®ã€‚T1 ç¬¬ä¸€æ¬¡è®€å–æ™‚ï¼ŒT2 é‚„æ²’ commitï¼Œä½† T1 ç¬¬äºŒæ¬¡è®€å–æ™‚ï¼ŒT2 å·²ç¶“ commit äº†ï¼Œæ­¤æ™‚ T1 è®€å–åˆ°çš„å­˜è²¨æ•¸é‡å°±æœƒæ¯”ç¬¬ä¸€æ¬¡å°‘ä¸€å€‹ã€‚

### Phantom Read

èˆ‰ä¾‹ï¼š

æœ‰ä¸€å€‹ transaction T1 ä¾†è®€å–æ‰€æœ‰è¨‚å–®ä¸¦è¨ˆç®—æ•¸é‡å…©æ¬¡ï¼ŒåŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æ­£åœ¨åŸ·è¡Œï¼ŒT2 åŒ…å«è®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ã€æ–°å¢ä¸€ç­†è¨‚å–®ã€‚T1 ç¬¬ä¸€æ¬¡è®€å–æ™‚ï¼ŒT2 é‚„æ²’æ–°å¢è¨‚å–®ï¼Œä½† T1 ç¬¬äºŒæ¬¡è®€å–æ™‚ï¼ŒT2 å·²ç¶“æ–°å¢è¨‚å–®ï¼Œæ­¤æ™‚ T1 è¨ˆç®—å‡ºä¾†çš„è¨‚å–®æ•¸é‡å°±æœƒæ¯”ç¬¬ä¸€æ¬¡å¤šä¸€å€‹ã€‚

>Non-Repeatable Read Anomaly æ˜¯ç”±ã€ŒæŸäº›è³‡æ–™çš„æŸäº›æ¬„ä½å€¼è¢«æ›´æ”¹ã€æ‰€å°è‡´ï¼›Phantom Read Anomaly å‰‡æ˜¯ç”±ã€Œæ–°å¢æˆ–åˆªé™¤æŸäº›è³‡æ–™ã€æ‰€å°è‡´ã€‚

### Lost Update

è‹¥å…©å€‹ä»¥ä¸Šçš„ transactions åŒæ™‚è¦æ›´æ”¹åŒä¸€ç­†è³‡æ–™ï¼Œè©²ç­†è³‡æ–™æœ€çµ‚çš„ç‹€æ…‹æ˜¯ç”±æœ€æ™š commit çš„ transaction æ±ºå®šã€‚

èˆ‰ä¾‹ï¼š

å…©å€‹ transactions T1, T2 åŒæ™‚è¦è®€å–å•†å“å­˜è²¨æ•¸é‡ï¼Œç„¶å¾Œå°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€‚å‡è¨­åŸå­˜è²¨æ•¸é‡ç‚º 100ï¼ŒT1, T2 éƒ½è®€åˆ° 100ï¼Œ-1 å¾Œå°±éƒ½æœƒæ˜¯ 99ï¼Œæ‰€ä»¥å•†å“å­˜è²¨å°±æœƒè¢«æ›´æ–°ç‚º 99 å…©æ¬¡ï¼Œç„¶è€Œï¼Œè¨‚å–®å»å¤šäº†å…©ç­†ï¼Œå°è‡´ã€Œå•†å“å­˜è²¨ + è¨‚å–®ã€çš„çµæœèˆ‡åŸæœ¬ä¸ä¸€è‡´ã€‚

![[lost_update.png]]

### Dirty Write

æ¯å€‹ Transactions é–“æ˜¯ç¨ç«‹çš„ï¼ŒåŸ·è¡Œ rollback çš„ transaction ä¸æœƒçŸ¥é“åœ¨è‡ªå·±é€™å€‹ transaction çš„éç¨‹ä¸­æ˜¯å¦æœ‰å…¶ä»– transaction å°åŒæ¨£çš„è³‡æ–™åšæ›´å‹•ï¼Œæ‰€ä»¥åªæœƒ rollback å›ã€Œå°è‡ªå·±è€Œè¨€ã€çš„åŸå§‹ç‹€æ…‹ï¼Œé€™æœƒå°è‡´éç¨‹ä¸­çš„å…¶å®ƒ transactions å°é€™äº›è³‡æ–™åšçš„æ›´å‹•éƒ½è¢«æŠ¹é™¤ã€‚

èˆ‰ä¾‹ï¼š

å…©å€‹ transactions T1, T2 éƒ½æ˜¯è¦ã€Œå…ˆè®€å–å•†å“å­˜è²¨æ•¸é‡ï¼Œç„¶å¾Œå°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œæœ€å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€ã€‚å‡è¨­åŸå­˜è²¨æ•¸é‡ç‚º 100ï¼ŒT1 å·²ç¶“è®€å–ä¸”ç‡å…ˆå°‡å…¶æ›´æ–°ç‚º 99ï¼Œæº–å‚™æ–°å¢è¨‚å–®ï¼Œæ­¤æ™‚ T2 æ‰è®€å–å­˜è²¨æ•¸é‡ (99)ï¼Œä¸¦ä¸”å°‡å…¶æ›´æ–°ç‚º 98ï¼Œç„¶å¾Œæº–å‚™æ–°å¢è¨‚å–®ã€‚ç„¶è€Œæ­¤æ™‚ T1 å› ç‚ºæ–°å¢è¨‚å–®å¤±æ•—è€Œ rollback å›ã€Œå°å®ƒ (T1) è€Œè¨€çš„åŸå§‹ç‹€æ…‹ã€ï¼Œæ‰€ä»¥å­˜è²¨æ•¸é‡è¢«æ”¹å› 100ï¼Œç„¶å¾Œ T2 æˆåŠŸæ–°å¢è¨‚å–®ã€‚æœ€çµ‚çš„çµæœæ˜¯å­˜è²¨ä¸è®Š (100)ï¼Œè¨‚å–®å»å¤šäº†ä¸€ç­†ã€‚

![[dirty_write.png]]

### Write Skew

ç¾åœ¨æœ‰å¤šå€‹åŒæ™‚é€²è¡Œé€²è¡Œçš„ transactionsï¼Œæœ‰å¯èƒ½å®ƒå€‘ã€Œå€‹åˆ¥ã€ä¾†çœ‹éƒ½ç¬¦åˆè³‡æ–™åº« schema çš„ constraintsï¼Œä½†ç¶œåˆèµ·ä¾†å¾Œå°±ä¸ç¬¦åˆäº†ã€‚

ç”±æ–¼é€™äº› transactions é–“æ˜¯ç¨ç«‹çš„ï¼Œä¸çŸ¥é“èˆ‡è‡ªå·±åŒæ™‚åœ¨é€²è¡Œçš„ transactions æœ‰å“ªäº›ä»¥åŠæœƒåšå“ªäº›äº‹ï¼Œæ‰€ä»¥ Write Skew Anomaly è¼ƒé›£åµæ¸¬åŠé é˜²ã€‚

èˆ‰ä¾‹ï¼š

å‡è¨­è³‡æ–™åº«ä¸­**å•†å“** relation æœ‰ã€Œå”®åƒ¹å¿…é ˆé«˜æ–¼æˆæœ¬ ã€é€™å€‹ constraintï¼Œç¾åœ¨æœ‰ä¸€å€‹å•†å“çš„å”®åƒ¹ç‚º 10 å…ƒï¼Œæˆæœ¬ç‚º 8 å…ƒï¼Œæ­¤æ™‚æœ‰ä¸€å€‹ transaction T1 æœƒå…ˆè®€å–å”®åƒ¹èˆ‡æˆæœ¬ï¼Œè‹¥æˆæœ¬ += 1 å…ƒå¾Œä»ç„¶ç¬¦åˆ constraintï¼Œå°±å°‡æˆæœ¬ += 1ï¼›åŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 ä¸€æ¨£å…ˆè®€å–å”®åƒ¹èˆ‡æˆæœ¬ï¼Œè‹¥å”®åƒ¹ -= 1 å…ƒå¾Œä»ç„¶ç¬¦åˆ constraintï¼Œå°±å°‡å”®åƒ¹ -= 1ï¼Œè‹¥ T1 èˆ‡ T2 è®€åˆ°çš„ `(å”®åƒ¹, æˆæœ¬)` çš†ç‚º `(10, 8)`ï¼Œä»–å€‘å°±éƒ½æœƒåˆ¤æ–·å¯ä»¥å°æˆæœ¬ï¼å”®åƒ¹é€²è¡Œæ›´æ”¹ï¼Œç„¶è€Œï¼Œè‹¥ T1 ç‡å…ˆå°‡æˆæœ¬ += 1 ä¸” commitï¼Œæ­¤æ™‚ T2 å†å°‡å”®åƒ¹ -= 1 å°±æœƒå› ä¸ç¬¦åˆ constraint è€Œç„¡æ³• commitã€‚

>Lost-Update Anomaly æ˜¯å…©å€‹ transactions æ›´æ”¹åŒä¸€ç­†è³‡æ–™çš„ä¸åŒæ¬„ä½ (disjoint set of data)ï¼›Write Skew Anomaly å‰‡æ˜¯æ›´æ”¹åŒä¸€ç­†è³‡æ–™çš„åŒä¸€å€‹æ¬„ä½ (overlapping set of data)ã€‚

# Concurrency Control Protocols

### åˆ†é¡

###### ç©æ¥µå‹

ä¸å¤šåšæª¢æŸ¥ï¼Œä¸ç®¡æœ‰å¤šå°‘å¹³è¡Œçš„ transactions éƒ½ç›´æ¥åŸ·è¡Œï¼Œå¦‚æœæœ‰èª° commit æ™‚å‡ºéŒ¯äº†ï¼Œå°± rollback é‚£äº›å‡ºéŒ¯çš„ transactions ä¸¦ re-executeï¼Œç›´åˆ°æˆåŠŸç‚ºæ­¢ã€‚

###### æ¶ˆæ¥µå‹

åŸ·è¡Œ transaction ä¸­çš„æ¯å€‹æ­¥é©Ÿæ™‚éƒ½å…ˆæª¢æŸ¥é€™å€‹å‹•ä½œæœƒä¸æœƒç ´å£ [[Integrity Constraint]]ï¼Œå¦‚æœæœƒçš„è©±å°±æŠŠè©² transaction block ä½ï¼Œç­‰å±æ©Ÿè§£é™¤å¾Œå†æ”¾è¡Œã€‚

ç”±æ–¼æ¶ˆæ¥µå‹çš„ protocols å®¹æ˜“å°è‡´ [[Deadlocks (æ­»çµ)]]ï¼Œå› æ­¤å¤šæ•¸ DBMS éƒ½æœ‰èˆ‡é˜²æ©Ÿåˆ¶ï¼Œæ¯”å¦‚å®šæœŸå°‡è¢« block éä¹…çš„ transaction åš rollback and re-executeã€‚

### æ‰‹æ®µ

###### ğŸ”“ Locking

ç•¶ä¸€å€‹ transaction T å­˜å–è³‡æ–™æ™‚ï¼Œå°‡é€™äº›è¢«å­˜å–çš„è³‡æ–™åŠ ä¸Š locksï¼Œè¢«åŠ ä¸Š lock çš„è³‡æ–™å°‡ç„¡æ³•è¢«å…¶å®ƒ transaction å­˜å–æˆ–åšæŸäº›æ“ä½œï¼ˆè¦– lock çš„ç¨®é¡è€Œå®šï¼‰ï¼Œç›´åˆ° T commit å¾Œæ‰å°‡ lock è§£é™¤ã€‚

###### Serialization Graph Checking

å°‡å¹³è¡ŒåŸ·è¡Œçš„ transactions è½‰æ›æˆèˆ‡å…¶ã€Œç­‰åƒ¹ã€ï¼ˆæœ€å¾Œæœƒç”¢ç”Ÿç›¸åŒè³‡æ–™åº«ç‹€æ…‹ï¼‰çš„ serialized schedualï¼Œè‹¥å°‡é€™å€‹ schedual è¦–è¦ºåŒ–ç‚ºæµç¨‹åœ–ï¼Œå‰‡åœ–è£¡æ‡‰ä¸èƒ½å‡ºç¾ä»»ä½•ã€Œå¾ªç’°ã€ï¼Œè‹¥å‡ºç¾å‰‡æ‡‰ä»¥ã€Œæœ€å°æˆæœ¬ã€å°‡é€ æˆå¾ªç’°çš„ transaction(s) æ‹”é™¤ã€‚

ä½†å»é™¤å¾ªç’°å¾Œï¼Œä¸¦ä¸ä¸€å®šè¦çœŸçš„æŒ‰ç…§ serialized schedual ä¸€å€‹æ¥è‘—ä¸€å€‹åŸ·è¡Œï¼Œä»å¯ä»¥é¸æ“‡åŒæ™‚åŸ·è¡Œã€‚

###### Timestamp Ordering

å°‡å¹³è¡ŒåŸ·è¡Œçš„ transactions è½‰æ›æˆèˆ‡å…¶ã€Œç­‰åƒ¹ã€ï¼ˆæœ€å¾Œæœƒç”¢ç”Ÿç›¸åŒè³‡æ–™åº«ç‹€æ…‹ï¼‰çš„ serialized schedualï¼Œä¸¦ç¢ºå¯¦ä¾åºåŸ·è¡Œã€‚å°‡æ¯å€‹ transaction æ¨™è¨˜ä¸€å€‹å”¯ä¸€çš„ timestampï¼Œç”¨ä¾†æ±ºå®šåŸ·è¡Œé †åºã€‚

###### Commitment Ordering

å°‡æ¯å€‹ transaction æ¨™è¨˜ä¸€å€‹å”¯ä¸€çš„ timestampï¼Œç”¨ä¾†æ±ºå®šã€Œcommit çš„é †åºã€ï¼Œä¸¦ä¸”ç¢ºä¿ä¸‹é¢å…©ä»¶äº‹ï¼š

- è¼ƒæ—©åŸ·è¡Œ commitment çš„ transaction ä¸æœƒå—åˆ° commitment order æ¯”è‡ªå·±æ™šçš„ transactions å½±éŸ¿

- è¼ƒæ™šåŸ·è¡Œ commitment çš„ transaction å¯ä»¥å­˜å–åˆ°æ¯”è‡ªå·±æ—© commit çš„ transactions å°è³‡æ–™åº«æ‰€åšçš„è®Šå‹•

>[!Note]
>ä¸Šè¿°é€™äº›æ‰‹æ®µä¸¦éåªèƒ½æ“‡ä¸€ï¼Œå¯ä»¥æ­é…ä½¿ç”¨ã€‚

### ä¸»æµåšæ³•

- [[MVCC vs. SS2PL#MVCC|MVCC (Multi-Version Concurrency Control)]]
- [[MVCC vs. SS2PL#SS2PL|SS2PL (Strong-Strict Two-Phase Locking)]]

# åƒè€ƒè³‡æ–™

- <https://en.wikipedia.org/wiki/Concurrent_computing>
- <https://en.wikipedia.org/wiki/Concurrency_control>
