# CAP Theorem (Brewer's Theorem)

---

CAP Theorem æŒ‡å‡ºï¼Œä¸€å€‹æœå‹™æœ€å¤šåªèƒ½åŒæ™‚ç¢ºä¿ Consistency, Availability èˆ‡ Partition Tolerance ä¸‰è€…çš„å…¶ä¸­å…©å€‹ï¼š

![[Screen Shot 2023-02-04 at 8.30.11 AM.png]]

- Consistency: End users ç¸½æ˜¯å¯ä»¥å¾è³‡æ–™åº«è®€å–åˆ°æœ€æ–°çš„è³‡æ–™
- Availability: æ‰€æœ‰ Request éƒ½æœƒå¾—åˆ° non-error çš„ Response
- Partition Tolerance: é™¤äº†é€šè¨Šå•é¡Œä»¥å¤–ï¼Œæœå‹™å¿…é ˆæŒçºŒé‹ä½œä¸é–“æ–·

è€Œ ACID Transaction Model çš„å®—æ—¨å³ã€Œåœ¨å…·å‚™ Partition Tolerance çš„æ¢ä»¶ä¸‹ï¼Œæä¾›å…·å‚™ Consistency çš„æœå‹™ã€ï¼ŒéŠ€è¡Œæ¥­é€šå¸¸æœƒéœ€è¦é€™ç¨® Modelã€‚

ç›¸å°åœ°ï¼ŒBASE Transaction Model çš„å®—æ—¨ç‚ºã€Œåœ¨å…·å‚™ Partition Tolerance çš„æ¢ä»¶ä¸‹ï¼Œæä¾›å…·å‚™ Availability çš„æœå‹™ã€ã€‚

# ä½•è¬‚ Transaction

---

Transaction æœ€åŸå§‹çš„å®šç¾©å…¶å¯¦å°±æ˜¯å­—é¢ä¸Šçš„æ„æ€ï¼šã€Œäº¤æ˜“ã€ï¼Œå¿…é ˆä¸€æ‰‹äº¤éŒ¢ä¸€æ‰‹äº¤è²¨ï¼Œä¸€æ—¦è²·æ–¹æ‹¿ä¸å‡ºéŒ¢ï¼Œæˆ–è€…è³£æ–¹ç„¡æ³•æä¾›è²¨å“ï¼Œæˆ–è€…è²·æ–¹ç„¡æ³•æ¥æ”¶è²¨å“ï¼Œæˆ–è€…è³£æ–¹ç„¡æ³•æ¥æ”¶éŒ¢ï¼Œé€™å€‹äº¤æ˜“å°±ä¸ç®—æˆåŠŸã€‚

åŒç†ï¼Œåœ¨è³‡æ–™åº«çš„ä¸–ç•Œä¸­ï¼Œä¸€å€‹ transaction å¯èƒ½åŒ…å«è‹¥å¹²å€‹èˆ‡è³‡æ–™åº«æºé€š (query) çš„æ­¥é©Ÿï¼Œæ‰€æœ‰æ­¥é©Ÿéƒ½åŸ·è¡ŒæˆåŠŸå¾Œï¼Œæœƒé€²è¡Œ "**commit**" ä¾†è¡¨ç¤ºé€™å€‹ transaction åŸ·è¡ŒæˆåŠŸã€‚

# ACID

---

### Atomicity

å¦‚æœä¸€å€‹ transaction ã€ŒåŸ·è¡ŒæˆåŠŸã€çš„å®šç¾©æ˜¯ã€Œtransaction ä¸­çš„æ¯å€‹æ­¥é©Ÿéƒ½æˆåŠŸã€ï¼Œ==è‹¥ä»»ä¸€å€‹æ­¥é©ŸåŸ·è¡Œå¤±æ•—ï¼Œå°±è¦ **rollback** åˆ°ç¬¬ä¸€å€‹æ­¥é©ŸåŸ·è¡Œå‰çš„ç‹€æ…‹ï¼Œå¥½åƒä»€éº¼äº‹éƒ½æ²’ç™¼ç”Ÿä¸€æ¨£==ï¼Œé‚£æˆ‘å€‘å°±èªªé€™å€‹ transaction å…·å‚™ atomicityï¼Œç™½è©±æ–‡å°±æ˜¯ã€Œä¸å¯åˆ†å‰²æ€§ã€ã€‚

ç•¶ä¸€å€‹ transaction ã€ŒåŸ·è¡ŒæˆåŠŸã€å¾Œï¼Œæœƒé€²è¡Œä¸€å€‹å« **commit** çš„å‹•ä½œï¼Œæ›è¨€ä¹‹ transaction çš„çµå±€æœ‰å…©ç¨®ï¼Œåˆ†åˆ¥å°æ‡‰åˆ°ä¸€å€‹å‹•ä½œï¼š

- æˆåŠŸï¼šåŸ·è¡Œ commit 
- å¤±æ•—ï¼šåŸ·è¡Œ rollback

ç‚ºä½•éœ€è¦ rollbackï¼Ÿå‡è¨­åœ¨ä¸€å€‹éŠ€è¡Œçš„è³‡æ–™åº«ä¸­ï¼Œaccount A è¦è½‰å¸³ n å…ƒçµ¦ account Bï¼Œæ’‡é™¤å…¶ä»–ç´°ç¯€ä¸è«‡ï¼Œæœ€é‡è¦çš„æ­¥é©Ÿæœ‰å…©å€‹ï¼š

1. å°‡ account A çš„ balance æ¸›å» n
2. å°‡ account B çš„ balance åŠ ä¸Š n

å¦‚æœæ­¥é©Ÿä¸€åŸ·è¡ŒæˆåŠŸã€æ­¥é©ŸäºŒåŸ·è¡Œå¤±æ•—ï¼Œä½†å»æ²’æœ‰ rollbackï¼Œé‚£ A çš„ n å…ƒå°±å¾é€™å€‹ä¸–ç•Œä¸Šè’¸ç™¼äº†ï¼Œç”±æ­¤å¯è¦‹ rollback çš„é‡è¦æ€§ã€‚

### Consistency

Consistency åŒ…æ‹¬ï¼š"Consistency in Data" èˆ‡ "Consistency in Read"

- **Consistency in Data**
	
	- [[Referential Integrity (åƒç…§å®Œæ•´æ€§)]]
	- å…¶ä»–è‡ªå®šç¾©çš„è¦å‰‡ï¼ˆæ¯”å¦‚ï¼šå•†å“çš„å”®åƒ¹ä¸€å®šè¦å¤§æ–¼æˆæœ¬ï¼‰

- **Consistency in Read**
	
	Transaction è®€åˆ°çš„è³‡æ–™æ°¸é æ˜¯æœ€æ–°çš„ã€‚åœ¨æŸäº›æƒ…å¢ƒä¸­ï¼Œå®Œç¾çš„ Consistency in Read æ˜¯å¾ˆé›£é”æˆçš„ï¼Œæ¯”å¦‚ç•¶æœå‹™æ˜¯ç”±ä¸æ­¢ä¸€å€‹ database åœ¨æŒç®¡è³‡æ–™æ™‚ï¼Œç”±æ–¼ database ä¹‹é–“çš„ syncing é ˆè¦æ™‚é–“ï¼Œé ˆè¦çµ¦ databases ä¸€é»æ™‚é–“æ‰èƒ½é”åˆ° Consistency in Readï¼Œé€™å«åš Eventual Consistencyã€‚

==Relational Database ç›¸å°æ–¼ NoSQL æœ€å¤§çš„å„ªå‹¢å³åœ¨æ–¼å‰è€…åœ¨å–®ä¸€ database çš„æƒ…å¢ƒä¸‹èƒ½æä¾› Consistencyï¼Œä½†å¾Œè€…é€šå¸¸åªèƒ½åšåˆ° Eventual Consistency==ã€‚

### Isolation

åœ¨å…·æœ‰ä¸€å®šç”¨æˆ¶æ•¸é‡çš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œã€ŒåŒæ™‚æœ‰å¤šä½ç”¨æˆ¶åœ¨å­˜å–è³‡æ–™åº«ã€æ˜¯å¾ˆå¸¸ç™¼ç”Ÿçš„äº‹ï¼Œweb app æœ‰èƒ½åŠ›å¹³è¡Œ (parallel) è™•ç†å¤šå€‹ requestsï¼Œè³‡æ–™åº«ä¹Ÿæœ‰èƒ½åŠ›å¹³è¡Œè™•ç†å¤šå€‹ queriesã€‚

>è³‡æ–™åº«æœƒå¹³è¡Œ (parallel) è™•ç†æ¯å€‹ä¸åŒ client connection æ‰€ç™¼èµ·çš„ queriesï¼›ä½†åŒä¸€å€‹ client connection æ‰€ç™¼èµ·çš„å¤šå€‹ queries å‰‡æœƒè¢«ä¸€å€‹æ¥è‘—ä¸€å€‹è™•ç†ã€‚

è€Œ Isolation çš„å®šç¾©å³ï¼šã€Œä»»å…©å€‹é€²è¡Œä¸­ (in-flight) çš„ transactions ä¸æ‡‰äº’ç›¸å½±éŸ¿ï¼å¹²æ“¾ï¼Œç”šè‡³ä¸æ‡‰çœ‹åˆ°å½¼æ­¤å°è³‡æ–™åº«æ‰€é€ æˆçš„å½±éŸ¿ã€ï¼Œå¦å‰‡å¯èƒ½æœƒå‡ºç¾ concurrency bugsã€‚

==å®Œç¾çš„ Isolation æ‡‰è©²åšåˆ°çš„æ˜¯ï¼šã€Œå¤šå€‹è¢«å¹³è¡ŒåŸ·è¡Œçš„ transactions åŸ·è¡Œå®Œå¾Œï¼Œè³‡æ–™åº«çš„ç‹€æ…‹ (state) èˆ‡ transactions ä¸€å€‹æ¥è‘—ä¸€å€‹è¢«åŸ·è¡Œçš„çµæœä¸€æ¨£ã€‚ã€==

å¸¸è¦‹çš„ Concurrency bugs åŒ…å«ä»¥ä¸‹å¹¾ç¨®ï¼š

- **Lost-Update Anomaly**
	
	èˆ‰ä¾‹ï¼š
	
	å…©å€‹ transactions T1, T2 åŒæ™‚è¦è®€å–å•†å“å­˜è²¨æ•¸é‡ï¼Œç„¶å¾Œå°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€‚å‡è¨­åŸå­˜è²¨æ•¸é‡ç‚º 100ï¼ŒT1, T2 éƒ½è®€åˆ° 100ï¼Œ-1 å¾Œå°±éƒ½æœƒæ˜¯ 99ï¼Œæ‰€ä»¥å•†å“å­˜è²¨å°±æœƒè¢«æ›´æ–°ç‚º 99 å…©æ¬¡ï¼Œç„¶è€Œï¼Œè¨‚å–®å»å¤šäº†å…©ç­†ï¼Œå°è‡´ã€Œå•†å“å­˜è²¨ + è¨‚å–®ã€çš„çµæœèˆ‡åŸæœ¬ä¸ä¸€è‡´ã€‚
 ^9c95ff
- **Dirty-Write Anomaly**
	
	èˆ‰ä¾‹ï¼š
	
	å…©å€‹ transactions T1, T2 åŒæ™‚è¦è®€å–å•†å“å­˜è²¨æ•¸é‡ï¼Œç„¶å¾Œå°‡å•†å“å­˜è²¨æ•¸é‡ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ã€‚å‡è¨­åŸå­˜è²¨æ•¸é‡ç‚º 100ï¼ŒT1 å·²ç¶“è®€å–ä¸”ç‡å…ˆå°‡å…¶æ›´æ–°ç‚º 99ï¼Œæº–å‚™æ–°å¢è¨‚å–®ï¼Œæ­¤æ™‚ T2 æ‰è®€å–å­˜è²¨æ•¸é‡ (99)ï¼Œä¸¦ä¸”å°‡å…¶æ›´æ–°ç‚º 98ï¼Œç„¶å¾Œæº–å‚™æ–°å¢è¨‚å–®ã€‚ç„¶è€Œæ­¤æ™‚ T1 å› ç‚ºæ–°å¢è¨‚å–®å¤±æ•—è€Œ rollback å›ã€Œå°å®ƒè€Œè¨€çš„åˆå§‹ç‹€æ…‹ã€ï¼Œæ‰€ä»¥å­˜è²¨æ•¸é‡è¢«æ”¹å› 100ï¼Œç„¶å¾Œ T2 æˆåŠŸæ–°å¢è¨‚å–®ã€‚æœ€çµ‚çš„çµæœæ˜¯å­˜è²¨ä¸è®Š (100)ï¼Œè¨‚å–®å»å¤šäº†ä¸€ç­†ã€‚

- **Dirty-Read Anomaly**
	
	èˆ‰ä¾‹ï¼š
	
	ä¸€å€‹ transaction T1 è¦å°‡å•†å“å­˜è²¨ -1ï¼Œç„¶å¾Œæ–°å¢ä¸€ç­†è¨‚å–®ï¼Œä½†åŸ·è¡Œåˆ°ä¸€åŠæ™‚ï¼ˆåªå°‡å•†å“å­˜è²¨ -1ï¼‰å¦ä¸€å€‹ transaction T2 ä¾†è®€å–å•†å“å­˜è²¨èˆ‡è¨‚å–®ï¼Œç›®çš„æ˜¯æª¢æŸ¥ã€Œå•†å“å­˜è²¨ + è¨‚å–®ã€çš„ç¸½å’Œæ˜¯å¦æœ‰èª¤ï¼Œæ­¤æ™‚ T2 å¾—åˆ°çš„çµè«–å°±æ˜¯ã€Œæœ‰èª¤ã€ï¼Œå› ç‚ºå®ƒçœ‹åˆ°çš„ç‹€æ…‹æ˜¯è¨‚å–®é‚„æ²’è¢«å»ºç«‹å‰çš„ç‹€æ…‹ï¼Œå³ä½¿ä¸ä¹…å¾Œ T1 å°±å»ºç«‹äº†è¨‚å–®ã€‚

- **Non-Repeatable Read Anomaly**
	
	èˆ‰ä¾‹ï¼š
	
	æœ‰ä¸€å€‹ transaction T1 ä¾†è®€å–å­˜è²¨æ•¸é‡å…©æ¬¡ï¼ŒåŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æ­£åœ¨åŸ·è¡Œï¼ŒT2 åŒ…å«è®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ã€æ–°å¢ä¸€ç­†è¨‚å–®ã€‚T1 ç¬¬ä¸€æ¬¡è®€å–æ™‚ï¼ŒT2 é‚„æ²’ commitï¼Œä½† T1 ç¬¬äºŒæ¬¡è®€å–æ™‚ï¼ŒT2 å·²ç¶“ commit äº†ï¼Œæ­¤æ™‚ T1 è®€å–åˆ°çš„å€¼å°±æœƒä¸åŒã€‚

- **Phantom Read Anomaly**
	
	èˆ‰ä¾‹ï¼š
	
	æœ‰ä¸€å€‹ transaction T1 ä¾†è®€å–æ‰€æœ‰è¨‚å–®ä¸¦è¨ˆç®—æ•¸é‡å…©æ¬¡ï¼ŒåŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æ­£åœ¨åŸ·è¡Œï¼ŒT2 åŒ…å«è®€å–å•†å“å­˜è²¨æ•¸é‡ã€å°‡å•†å“å­˜è²¨æ•¸é‡ -1ã€æ–°å¢ä¸€ç­†è¨‚å–®ã€‚T1 ç¬¬ä¸€æ¬¡è®€å–æ™‚ï¼ŒT2 é‚„æ²’æ–°å¢è¨‚å–®ï¼Œä½† T1 ç¬¬äºŒæ¬¡è®€å–æ™‚ï¼ŒT2 å·²ç¶“æ–°å¢è¨‚å–®ï¼Œæ­¤æ™‚ T1 è¨ˆç®—å‡ºä¾†çš„æ•¸é‡å°±æœƒä¸åŒã€‚
	
	> Phantom Read Anomaly èˆ‡ Non-Repeatable Read Anomaly çš„å·®åˆ¥åœ¨æ–¼ï¼šå¾Œè€…æ˜¯ç”±ã€ŒæŸäº›è³‡æ–™çš„æŸäº›æ¬„ä½å€¼è¢«æ›´æ”¹ã€æ‰€å°è‡´ï¼›å‰è€…å‰‡æ˜¯ç”±ã€Œæ–°å¢æˆ–åˆªé™¤æŸäº›è³‡æ–™ã€æ‰€å°è‡´ã€‚

- **Write Skew Anomaly**
	
	èˆ‰ä¾‹ï¼š
	
	å‡è¨­è³‡æ–™åº«ä¸­å•†å“è¡¨æœ‰ä»¥ä¸‹ constraintï¼šã€Œå”®åƒ¹å¿…é ˆé«˜æ–¼æˆæœ¬ ã€ï¼Œä¸¦ä¸”å­˜åœ¨ä¸€å€‹å•†å“çš„å”®åƒ¹ç‚º 10 å…ƒï¼Œæˆæœ¬ç‚º 8 å…ƒã€‚æ­¤æ™‚æœ‰ä¸€å€‹ transaction T1 æœƒå…ˆè®€å–å”®åƒ¹èˆ‡æˆæœ¬ï¼Œè‹¥æˆæœ¬ +1 å…ƒå¾Œä»ç„¶ç¬¦åˆ constraintï¼Œå°±å°‡æˆæœ¬ +1ï¼›åŒæ™‚æœ‰å¦ä¸€å€‹ transaction T2 æœƒå…ˆè®€å–å”®åƒ¹èˆ‡æˆæœ¬ï¼Œè‹¥å”®åƒ¹ -1 å…ƒå¾Œä»ç„¶ç¬¦åˆ constraintï¼Œå°±å°‡å”®åƒ¹ -1ï¼Œå‡è¨­ T1 èˆ‡ T2 è®€åˆ°å”®åƒ¹èˆ‡æˆæœ¬çš†ç‚º (10, 8)ï¼Œå› æ­¤ä»–å€‘éƒ½æœƒåˆ¤æ–·å¯ä»¥å°æˆæœ¬ï¼å”®åƒ¹é€²è¡Œæ›´æ”¹ï¼Œå‡è¨­ T1 ç‡å…ˆå°‡æˆæœ¬ +1ï¼Œæ­¤æ™‚ T2 å°‡å”®åƒ¹ -1 å°±æœƒå ±éŒ¯ã€‚
	
	>Write Skew Anomaly èˆ‡ Lost-Update Anomaly çš„å·®åˆ¥åœ¨æ–¼ï¼šå¾Œè€…æ˜¯å…©å€‹ transaction æ›´æ”¹åŒä¸€ç­†è³‡æ–™çš„ä¸åŒæ¬„ä½ (disjoint set of data)ï¼›å‰è€…å‰‡æ˜¯æ›´æ”¹åŒä¸€ç­†è³‡æ–™çš„åŒä¸€å€‹æ¬„ä½ (overlapping set of data)ã€‚

SQL Standard å°‡ Isolation ç”±å¯¬é¬†åˆ°åš´æ ¼åˆ†ç‚ºå››ç¨®ç­‰ç´šï¼š

|Isolation Level|Dirty read|Non-repeatable read|Phantom Read|
|---|---|---|---|
|Read Uncommitted|âœ… Possible|âœ… Possible|âœ… Possible|
|Read Committed|ğŸš« Not Possible|âœ… Possible|âœ… Possible|
|Repeatable Read|ğŸš« Not Possible|ğŸš« Not Possible|âœ… Possible|
|Serializable|ğŸš« Not Possible|ğŸš« Not Possible|ğŸš« Not Possible|

ç”±ä¸Šè¡¨å¯è¦‹ï¼ŒSQL Standard ç”¨ä¾†ç•Œå®š Isolation level çš„ anomalies å…¶å¯¦å¾ˆå°‘ï¼ˆéƒ½åªèˆ‡ã€Œè®€å–ã€ç›¸é—œï¼‰ï¼Œæ‰€ä»¥å…¶å¯¦é€™äº› level é–“çš„ç•Œç·šæ˜¯æ¨¡ç³Šçš„ï¼Œä¸”å°±ç®—æ˜¯æœ€é«˜éšçš„ Serializable ä¹Ÿä¸æ˜¯å®Œç¾çš„ Isolationã€‚

- **Read Uncommitted** (No Isolation)
	
	ä¸€å€‹ transaction å¯ä»¥è®€åˆ°å¦ä¸€å€‹ã€ŒåŸ·è¡Œåˆ°ä¸€åŠã€çš„ transaction å°è³‡æ–™åº«æ‰€åšçš„ã€Œæ‰€æœ‰æ›´å‹•ã€ã€‚
	
	![[Screen Shot 2023-02-02 at 1.02.18 PM.png]]

- **Read Committed**
	
	ä¸€å€‹ transaction å¯ä»¥è®€åˆ°å¦ä¸€å€‹ã€ŒåŸ·è¡Œå®Œã€çš„ transaction å°è³‡æ–™åº«æ‰€åšçš„ã€Œæ‰€æœ‰æ›´å‹•ã€ã€‚
	
	![[Screen Shot 2023-02-02 at 1.02.33 PM.png]]

- **Repeatable Read**
	
	ä¸€å€‹ transaction å¯ä»¥è®€åˆ°å¦ä¸€å€‹ã€ŒåŸ·è¡Œå®Œã€çš„ transaction åœ¨è³‡æ–™åº«ã€Œæ–°å¢ã€çš„è³‡æ–™ï¼Œä½†è®€ä¸åˆ°èˆŠè³‡æ–™ã€Œè¢«æ›´æ”¹å¾Œçš„å€¼ã€ã€‚
	
	![[Screen Shot 2023-02-02 at 1.17.00 PM.png]]

- **Serializable**
	
	ä¸€å€‹ transaction è®€ä¸åˆ°æ‰€æœ‰åœ¨å®ƒé–‹å§‹ä¹‹å¾Œï¼Œæ‰€æœ‰ä»–ä»¥å¤–çš„ transaction å°è³‡æ–™åº«åšçš„ã€Œæ‰€æœ‰æ›´å‹•ã€ã€‚
	
	![[Screen Shot 2023-02-02 at 1.21.35 PM.png]]

### Durability

ä¸€æ—¦ transaction è¢« commit äº†ï¼Œå³ä½¿å¾Œä¾†ç³»çµ±ç•¶æ©Ÿï¼Œçµæœä¹Ÿæ‡‰è©²ä¿å­˜è‘—ã€‚

æœ‰äº›æœå‹™ä½¿ç”¨ Memory ä¾†é”åˆ° Caching æ©Ÿåˆ¶ï¼ˆå¦‚ Redisï¼‰ï¼Œé€™ç¨®æœå‹™å°±ä¸ç¬¦åˆ Durabilityã€‚

# BASE

---

### Basically Available

### Soft State

### Eventually Consistent

# åƒè€ƒè³‡æ–™

---

https://en.wikipedia.org/wiki/CAP_theorem

https://www.youtube.com/watch?v=pomxJOFVcQs

https://phoenixnap.com/kb/acid-vs-base

https://fauna.com/blog/introduction-to-transaction-isolation-levels

https://stackoverflow.com/questions/4980801/how-simultaneous-queries-are-handled-in-a-mysql-database